<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SOAP Note Tool â€” v5.9</title>
<style>
:root {
  /* Hybrid theme: slightly darker background, soft light cards, strong blue accents */
  --bg: #d4dbe3;
  --bg-gradient-top: #e5ebf3;
  --bg-gradient-bottom: #c3ccd8;

  --card: #f9fafb;
  --card-sub: #f3f4f6;

  --muted: #4b5563;
  --muted-soft: #6b7280;

  --accent: #1d4ed8;   /* main navy blue */
  --accent2: #2563eb;  /* hover/secondary blue */
  --accent3: #0b2f6b;  /* darkest blue (ON state) */

  --border: #cbd2da;
  --border-strong: #9ca3af;

  --radius: 8px;
}

/* Base layout */
html, body {
  margin: 0;
  padding: 0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
  background: radial-gradient(circle at top, var(--bg-gradient-top) 0, var(--bg-gradient-bottom) 55%, #b2bccb 100%);
  color: #111827;
}

/* Main wrapper */
.wrap {
  max-width: 1440px;
  margin: 0 auto;
  padding: 18px 18px 28px;
}

/* App columns */
.app {
  display: flex;
  gap: 18px;
  align-items: flex-start;
}

/* Left column = builders */
.left {
  width: 58%;
  margin-right: 2%;
}

/* Right column = SOAP note */
.right {
  width: 40%;
}

/* Cards / panels */
.card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px 18px;
  margin-bottom: 14px;
  box-shadow: 0 18px 40px rgba(15, 23, 42, 0.18);
}

/* Subcards inside sections */
.subcard {
  background: var(--card-sub);
  border-radius: 10px;
  border: 1px solid #d1d5db;
  padding: 8px 10px;
  margin: 10px 0;
}

/* Card headers / summary (details) */
details.card > summary,
details.subcard > summary {
  list-style: none;
  cursor: pointer;
  font-size: 15px;
  font-weight: 600;
  color: #111827;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 6px 0;
}

/* Remove default triangle */
details summary::-webkit-details-marker {
  display: none;
}

/* Chevron */
.chev {
  font-size: 13px;
  color: var(--muted-soft);
}

/* Inner content of subcards */
.inner {
  margin-top: 6px;
}

/* Generic card body wrapper */
.card-body {
  margin-top: 6px;
}

.card h2 {
  margin: 0 0 10px;
  font-size: 18px;
  font-weight: 600;
  color: #111827;
}

/* Labels & small text */
label,
.section-label,
.small {
  font-size: 13px;
  font-weight: 500;
  color: var(--muted);
}

.muted {
  font-size: 12px;
  color: var(--muted-soft);
}

/* Inputs / textareas */
input[type="text"],
input[type="number"],
textarea,
select {
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 4px 6px;
  font-size: 13px;
  box-sizing: border-box;
  background: #ffffff;
}

/* Make selects visually consistent */
select {
  padding-top: 6px;
  padding-bottom: 6px;
}

/* Free textarea defaults */
textarea {
  width: 100%;
  resize: vertical;
}

/* Legacy collapsible buttons (if any are still used) */
.section-btn {
  width: 100%;
  text-align: left;
  background: #eef1f7;
  border: 1px solid var(--border);
  padding: 8px 10px;
  margin: 8px 0;
  border-radius: var(--radius);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: space-between;
  color: #111827;
  transition: background 0.15s, border-color 0.15s;
}

.section-btn:hover {
  background: #e0e7f6;
  border-color: var(--border-strong);
}

.section-content {
  display: none;
  padding-top: 6px;
}

/* Main action buttons (Copy Note, Clear Note, Clear sections, etc.) */
.btn {
  background: linear-gradient(to bottom, var(--accent2), var(--accent));
  color: #fff;
  border: 1px solid var(--accent2);
  border-radius: var(--radius);
  padding: 8px 12px;
  font-size: 13px;
  font-weight: 600;
  letter-spacing: 0.3px;
  text-transform: uppercase;
  cursor: pointer;
  box-shadow: 0 2px 4px rgba(15, 23, 42, 0.35);
  transition:
    background 0.15s,
    box-shadow 0.15s,
    transform 0.08s,
    border-color 0.15s;
}

.btn:hover {
  background: linear-gradient(to bottom, #3b82f6, var(--accent2));
  box-shadow: 0 3px 7px rgba(15, 23, 42, 0.45);
}

.btn:active {
  transform: translateY(1px);
  box-shadow: 0 1px 3px rgba(15, 23, 42, 0.4);
}

/* Global toggled state for buttons that behave like toggles (outside .row as well) */
.btn.toggled {
  background: var(--accent3);
  border-color: #020617;
  box-shadow: 0 0 0 1px rgba(15, 23, 42, 0.35), 0 3px 7px rgba(15, 23, 42, 0.5);
}

/* Secondary / reset buttons */
.btn.reset {
  background: #4b5563;
  border-color: #374151;
  color: #fff;
}

.btn.reset:hover {
  background: #374151;
}

/* Row for generate / clear note buttons */
.btn-row {
  display: flex;
  gap: 10px;
  margin-top: 10px;
}

/* AS/AD two-column layout */
.grid-2 {
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 8px 16px;
}

/* 3-column layout for orders section */
.grid-3 {
  display: grid;
  grid-template-columns: repeat(3, minmax(0, 1fr));
  gap: 8px 16px;
}

/* Area where the two "COPY â–¶  â—€ COPY" buttons live */
.copy-arrows {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  margin-bottom: 4px;
}

.copy-arrows .spacer {
  visibility: hidden;
  pointer-events: none;
}

/* Make Left (AS) + Copy row and Right (AD) label the same height 
   so the two columns align cleanly */
.hist-grid > div:first-child .copy-arrows,
.hist-grid > div:nth-child(2) > .small:first-child {
  min-height: 32px; /* tweak this number if you want tighter / looser spacing */
}

/* Make the AS/AD headers line up nicely */
.grid-2 > div {
  display: flex;
  flex-direction: column;
}

/* Treat the first .small in each column like a header row */
.grid-2 > div > .small:first-child {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 6px;
  margin-bottom: 4px;
}

/* AS/AD grids that have a COPY button in the left column */
.asad-grid > div:first-child .copy-arrows,
.asad-grid > div:nth-child(2) > .small:first-child {
  min-height: 32px; /* adjust if you want tighter/looser spacing */
}

/* Slightly tighter spacing under COPY rows in AS/AD grids */
.asad-grid .copy-arrows {
  margin-bottom: 2px;
}

/* Rows that hold the many option buttons */
.row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin: 4px 0 8px;
}

/* === OPTION BUTTONS (history, patient reports, etc.) ===
   These are the smaller pill/toggle buttons inside .row.
   OFF: light gray
   HOVER: medium blue
   ON: dark rich blue
*/
.row .btn {
  background: #f3f4f6;
  color: #111827;
  border: 1px solid #d1d5db;
  border-radius: 16px;
  padding: 6px 10px;
  font-size: 13px;
  font-weight: 500;
  text-transform: none;
  letter-spacing: 0;
  box-shadow: none;
}

.row .btn:hover {
  background: var(--accent2);
  color: #ffffff;
  border-color: var(--accent2);
}

/* ON state (strong contrast) */
.row .btn.toggled {
  background: var(--accent3);
  color: #ffffff;
  border-color: var(--accent3);
}

/* If any sections use .toggle instead of .btn, match the same behavior */
.toggle {
  background: #f3f4f6;
  color: #111827;
  border: 1px solid #d1d5db;
  border-radius: 16px;
  font-size: 13px;
  padding: 6px 10px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s, color 0.15s, border 0.15s, transform 0.08s;
}

.toggle:hover {
  background: var(--accent2);
  color: #ffffff;
  border-color: var(--accent2);
}

.toggle.active {
  background: var(--accent3);
  color: #ffffff;
  border-color: var(--accent3);
}

/* Chips for custom lines (objective/assessment/plan) */
.chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 4px;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  padding: 3px 7px;
  border-radius: 999px;
  background: #e5e7eb;
  color: #111827;
  font-size: 12px;
}

.chip > button {
  border: none;
  background: transparent;
  cursor: pointer;
  padding: 0 2px;
  font-size: 12px;
  line-height: 1;
  color: #6b7280;
}

/* Fixed SOAP note on the right */
.right .card {
  position: fixed;
  top: 16px;
  right: 24px;
  width: 40%;
  max-width: 520px;
}

/* Note header inside right card */
.right header {
  font-size: 16px;
  font-weight: 600;
  color: #111827;
  margin-bottom: 8px;
}

/* Scrollable note area */
#noteArea {
  display: block;
  width: 100%;
  max-height: calc(100vh - 200px);
  height: calc(100vh - 200px);
  min-height: 420px;
  overflow: auto;
  padding: 10px;
  border-radius: var(--radius);
  border: 1px solid var(--border-strong);
  background: #ffffff;
  white-space: pre-wrap;
  font-size: 14px;
  line-height: 1.5;
  font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

/* Tiny helper text under note */
.note-hint {
  font-size: 12px;
  color: var(--muted-soft);
  margin-top: 6px;
}

/* Note controls (Copy Note / Clear Note) */
.note-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  margin-top: 8px;
}

/* Basic responsive fallback if the window gets too narrow */
@media (max-width: 1100px) {
  .app {
    flex-direction: column;
  }

  .left,
  .right {
    width: 100%;
    margin-right: 0;
  }

  .right .card {
    position: static;
    width: 100%;
    max-width: none;
    margin-top: 10px;
  }

  #noteArea {
    max-height: 400px;
    height: 400px;
  }
}

/* --- MAKE PLAN BUTTONS MATCH ALL OTHER TOGGLE BUTTONS --- */

/* OFF state (light gray) */
#plan-body .btn {
  background: #f3f4f6 !important;
  color: #111827 !important;
  border: 1px solid #d1d5db !important;
  border-radius: 16px !important;
  padding: 6px 10px !important;
  font-size: 13px !important;
  font-weight: 500 !important;
  text-transform: none !important;
  letter-spacing: 0 !important;
  box-shadow: none !important;
}

/* HOVER state (medium blue) */
#plan-body .btn:hover {
  background: var(--accent2) !important;
  color: #ffffff !important;
  border-color: var(--accent2) !important;
}

/* ON state (dark blue) */
#plan-body .btn.toggled {
  background: var(--accent3) !important;
  color: #ffffff !important;
  border-color: var(--accent3) !important;
}

.mt-4 { margin-top: 4px; }
.mt-6 { margin-top: 6px; }
.mt-8 { margin-top: 8px; }
.mt-10 { margin-top: 10px; }
.mt-12 { margin-top: 12px; }
.mt-16 { margin-top: 16px; }

.patient-order .grid-2 > div,
.patient-order .grid-3 > div {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.patient-order input,
.patient-order select,
.patient-order textarea {
  width: 100%;
}

.patient-order label.small {
  font-weight: 500;
  margin-bottom: 2px;
}

.patient-order h4 {
  margin-top: 12px;
  margin-bottom: 8px;
}

.patient-order .row {
  align-items: center;
  gap: 10px;
}

.patient-order .btn {
  margin-right: 4px;
}


</style>

</head>
<body>
<div class="wrap">
  <h1>SOAP Note Tool â€” Version 5.9</h1>
  <div class="app">

    <!-- LEFT -->
    <div class="left">

      <!-- SUBJECTIVE -->
<details class="card" id="sec-subjective" open>
  <summary>Subjective <span class="chev">â–¶</span></summary>
  <div class="card-body" id="subjective-body">

    <h4>Appointment Type</h4>
    <div id="apptButtons" class="row">
      <button class="btn" data-appt="comprehensive hearing test">CHT</button>
      <button class="btn" data-appt="hearing aid evaluation">HAE</button>
      <button class="btn" data-appt="hearing aid consultation">HAC</button>
      <button class="btn" data-appt="hearing aid delivery">HAD</button>
      <button class="btn" data-appt="in-warranty hearing aid check and clean">HACK I/W</button>
      <button class="btn" data-appt="out-of-warranty hearing aid check and clean">HACK O/W</button>
      <button class="btn" data-appt="first follow-up appointment">1st F/U</button>
      <button class="btn" data-appt="Annual hearing test">Annual test</button>
      <button class="btn" data-appt="re-delivery appointment">Re-Del</button>
    </div>

    <div class="grid-2">
      <div>
        <label class="small">Companion</label>
        <input type="text" id="subjective-companion" placeholder="e.g., with spouse John"/>
      </div>
    </div>

    <h4>History (AS/AD items; vertigo/dizziness is general)</h4>
    <div class="grid-2 asad-grid">
      <div>
        <div class="copy-arrows">
          <span class="small">Left (AS)</span>
          <button class="btn" data-copy="hist-AS-to-AD">Copy â–¶</button>
        </div>
        <div id="hist-AS" class="row"></div>
      </div>

      <div>
        <span class="small">Right (AD)</span>
        <div id="hist-AD" class="row"></div>
      </div>
    </div>

    <label class="small">General (applies to both ears)</label>
    <div id="hist-general" class="row"></div>

    <div class="grid-2">
      <div>
        <label class="small">Additional history (optional)</label>
        <input type="text" id="hist-additional" placeholder="e.g., gradual onset over 5 years"/>
      </div>
      <div>
        <label class="small">History of hearing aid use (optional)</label>
        <input type="text" id="hist-hause" placeholder="e.g., prior HA use for 3 years"/>
      </div>
    </div>

    <div class="row">
      <button class="btn" id="btn-history-all">Denies all</button>
      <button class="btn reset" id="btn-history-clear">Clear history</button>
    </div>

    <h4>Patient Reports</h4>
    <div class="grid-2 asad-grid">
      <div>
        <div class="copy-arrows">
          <span class="small">General â€” Left (AS)</span>
          <button class="btn" data-copy="rgen-AS-to-AD">Copy â–¶</button>
        </div>
        <div id="reports-gen-AS" class="row"></div>

        <div class="copy-arrows">
          <span class="small">Hearing Aid â€” Left (AS)</span>
          <button class="btn" data-copy="rha-AS-to-AD">Copy â–¶</button>
        </div>
               <div id="reports-ha-AS" class="row"></div>
        <!-- Removed per-ear AS custom textarea -->

      </div>

      <div>
        <span class="small">General â€” Right (AD)</span>
        <div id="reports-gen-AD" class="row"></div>

        <div class="copy-arrows">
          <span class="small">Hearing Aid â€” Right (AD)</span>
          <button class="btn spacer" type="button" tabindex="-1" aria-hidden="true">Copy â–¶</button>
        </div>
        <div id="reports-ha-AD" class="row"></div>
        <!-- Removed per-ear AD custom textarea -->

      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <textarea id="custom-subjective" rows="3"
        placeholder="Additional Subjective info"></textarea>
    </div>

  </div>
</details>

<!-- OBJECTIVE -->
<details class="card" id="sec-objective" open>
  <summary>Objective <span class="chev">â–¶</span></summary>
  <div class="card-body" id="objective-body">

    <details class="subcard" id="otoscopy-sub" open>
      <summary>Otoscopy <span class="chev">â–¶</span></summary>
      <div class="inner">
        <div class="grid-2 asad-grid">

          <div>
            <div class="copy-arrows">
              <span class="small">Left (AS)</span>
              <button class="btn" data-copy="oto-AS-to-AD">Copy â–¶</button>
            </div>
            <label class="small">Canal</label>
            <div id="oto-AS-canal" class="row"></div>

            <label class="small">TM</label>
            <div id="oto-AS-tm" class="row"></div>

            <div class="row">
              <textarea id="oto-AS-custom" rows="3"
                placeholder="Additional Otoscopy info (AS)"></textarea>
            </div>
          </div>

          <div>
            <span class="small">Right (AD)</span>

            <label class="small">Canal</label>
            <div id="oto-AD-canal" class="row"></div>

            <label class="small">TM</label>
            <div id="oto-AD-tm" class="row"></div>

            <div class="row">
              <textarea id="oto-AD-custom" rows="3"
                placeholder="Additional Otoscopy info (AD) â€” live"></textarea>
            </div>
          </div>

        </div>
      </div>
    </details>

    <details class="subcard" id="audiogram-obj-sub" open>
      <summary>Audiogram (Outside Report) <span class="chev">â–¶</span></summary>
      <div class="inner">

        <div class="row">
          <input type="text" id="audio-obj-src" placeholder="Doctor/Company (optional)"/>
        </div>

        <div class="grid-2 asad-grid">

          <div>
            <div class="copy-arrows">
              <span class="small">Left (AS)</span>
              <button class="btn" data-copy="aobj-AS-to-AD">Copy â–¶</button>
            </div>

            <label class="small">Degree (max 2)</label>
            <div id="audio-obj-AS-deg" class="row"></div>

            <label class="small">Type (max 1)</label>
            <div id="audio-obj-AS-type" class="row"></div>

            <label class="small">Configuration (max 1)</label>
            <div id="audio-obj-AS-conf" class="row"></div>

            <div class="row">
              <textarea id="audio-obj-AS-custom" rows="3"
                placeholder="Additional Audiogram info (AS)"></textarea>
            </div>

          </div>

          <div>
            <span class="small">Right (AD)</span>

            <label class="small">Degree (max 2)</label>
            <div id="audio-obj-AD-deg" class="row"></div>

            <label class="small">Type (max 1)</label>
            <div id="audio-obj-AD-type" class="row"></div>

            <label class="small">Configuration (max 1)</label>
            <div id="audio-obj-AD-conf" class="row"></div>

            <div class="row">
              <textarea id="audio-obj-AD-custom" rows="3"
                placeholder="Additional Audiogram info (AD)"></textarea>
            </div>

          </div>

        </div>
      </div>
    </details>

    
<!-- Medical Clearance now ABOVE Hearing Aid Condition -->
<details class="subcard" id="clearance-sub" open>
  <summary>Medical Clearance <span class="chev">â–¶</span></summary>
  <div class="inner">

    <div class="row">
      <label class="small">Doctor</label>
      <input
        type="text"
        id="clearance-doc"
        placeholder="e.g. Dr. Smith"
      />
    </div>

    <div class="row" style="margin-top:8px;">
      <label class="small">Status</label>
      <div class="row">
        <button class="btn" data-clearance="received">Received</button>
        <button class="btn" data-clearance="not">Not received</button>
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <label class="small">Ear(s)</label>
      <div class="row">
        <button class="btn" data-clear-ear="AS">AS</button>
        <button class="btn" data-clear-ear="AD">AD</button>
      </div>
      <span class="small" style="display:block;margin-top:4px;">
        Select both for AU in the note.
      </span>
    </div>

  </div>
</details>

<details class="subcard" id="hacond-sub" open>
  <summary>Hearing Aid Condition <span class="chev">â–¶</span></summary>
  <div class="inner grid-2 asad-grid">

    <div>
      <div class="copy-arrows">
        <span class="small">Left (AS)</span>
        <button class="btn" data-copy="hac-AS-to-AD">Copy â–¶</button>
      </div>

      <div id="hac-AS" class="row"></div>
      <!-- Removed AS custom box -->
    </div>

    <div>
      <span class="small">Right (AD)</span>
      <div id="hac-AD" class="row"></div>
      <!-- Removed AD custom box -->
    </div>

  </div>
</details>

<div class="row" style="margin-top:8px;">
  <textarea id="custom-objective" rows="3"
    placeholder="Additional Objective info"></textarea>
</div>

  </div>
</details>

<!-- ASSESSMENT -->
<details class="card" id="sec-assessment" open>
  <summary>Assessment <span class="chev">â–¶</span></summary>
  <div class="card-body" id="assessment-body">

    <details class="subcard" id="audiogram-assess-sub" open>
      <summary>In-Office Audiogram <span class="chev">â–¶</span></summary>
      <div class="inner grid-2 asad-grid">

        <div>
          <div class="copy-arrows">
            <span class="small">Left (AS)</span>
            <button class="btn" data-copy="audio-AS-to-AD">Copy â–¶</button>
          </div>

          <label class="small">Degree (max 2)</label>
          <div id="audio-AS-deg" class="row"></div>

          <label class="small">Type (max 1)</label>
          <div id="audio-AS-type" class="row"></div>

          <label class="small">Configuration (max 1)</label>
          <div id="audio-AS-conf" class="row"></div>

          <div class="row">
            <textarea id="audio-AS-custom" rows="3"
              placeholder="Additional Audiogram info (AS)"></textarea>
          </div>

        </div>

        <div>
          <span class="small">Right (AD)</span>

          <label class="small">Degree (max 2)</label>
          <div id="audio-AD-deg" class="row"></div>

          <label class="small">Type (max 1)</label>
          <div id="audio-AD-type" class="row"></div>

          <label class="small">Configuration (max 1)</label>
          <div id="audio-AD-conf" class="row"></div>

          <div class="row">
            <textarea id="audio-AD-custom" rows="3"
              placeholder="Additional Audiogram info (AD)"></textarea>
          </div>

        </div>

      </div>
    </details>

    <!-- INSURANCE MOVED UP HERE as requested -->
    <details class="subcard" id="ins-sub" open>
      <summary>Insurance Information<span class="chev">â–¶</span></summary>
      <div class="inner">

        <div class="row">
          <input type="text" id="ins-company" placeholder="Insurance Company"/>
        </div>

        <div class="row">
          <input type="text" id="ins-benefit" placeholder="Hearing Aid Benefit"/>
        </div>

        <div class="row">
          <input type="text" id="ins-oop" placeholder="Estimated Out-of-Pocket"/>
        </div>

        <div class="row">
          <button class="btn" data-auth="authorized">Authorized</button>
          <button class="btn" data-auth="pending">Pending</button>
          <button class="btn" data-auth="denied">Denied</button>
        </div>

      </div>
    </details>

<details class="subcard" id="ha-rec-sub" open>
  <summary>Hearing Aid Recommendation & Patient Choice <span class="chev">â–¶</span></summary>
  <div class="inner">

    <!-- =====================
         RECOMMENDATION
         ===================== -->
    <h4>Recommendation</h4>

    <div class="row">
      <label class="small">Ear(s) (recommendation)</label>
      <div class="row">
        <button class="btn" data-recscope="AS">AS</button>
        <button class="btn" data-recscope="AD">AD</button>
      </div>
    </div>

    <div class="row">
      <label class="small">Style (recommendation)</label>
      <div class="row" id="ha-style-row"></div>
    </div>

    <div class="row">
      <label class="small">Coupling (recommendation)</label>
      <div class="row" id="ha-coupling-row"></div>
    </div>

    <div class="row">
      <label class="small">Hearing aid details</label>
      <input
        type="text"
        id="ha-tech"
        placeholder="e.g., Starkey Evolv AI 1000"
      />
    </div>

    <hr class="sep"/>

    <!-- =====================
         PATIENT ORDER
         ===================== -->
<h4>Patient Order</h4>

<div class="patient-order">

  <!-- Ear scope -->
  <div class="row mt-6">
    <label class="small">Ear(s) (order)</label>
    <div class="row">
      <button class="btn" data-orderscope="AS">AS</button>
      <button class="btn" data-orderscope="AD">AD</button>
    </div>
  </div>

  <!-- Basic device details -->
  <div class="grid-3 mt-8">
    <div>
      <label class="small">Manufacturer</label>
      <input
        type="text"
        id="order-mfg"
        list="ha-mfg-list"
        placeholder="e.g., Starkey"
      />
      <datalist id="ha-mfg-list">
        <option value="Starkey"></option>
        <option value="Phonak"></option>
        <option value="Oticon"></option>
        <option value="ReSound"></option>
        <option value="Signia"></option>
        <option value="Widex"></option>
      </datalist>
    </div>

    <div>
      <label class="small">Model</label>
      <input
        type="text"
        id="order-model"
        list="ha-model-list"
        placeholder="e.g., Evolv AI 1000"
      />
      <datalist id="ha-model-list">
        <option value="Evolv AI 1000"></option>
        <option value="Evolv AI 1200"></option>
        <option value="Genesis AI 12"></option>
        <option value="Genesis AI 20"></option>
        <option value="Audeo L30"></option>
        <option value="Audeo L50"></option>
        <option value="ReSound Key 2"></option>
      </datalist>
    </div>

    <div>
      <label class="small">Hearing aid color</label>
      <input
        type="text"
        id="order-color"
        list="ha-color-list"
        placeholder="e.g., champagne"
      />
      <datalist id="ha-color-list">
        <option value="champagne"></option>
        <option value="black"></option>
        <option value="silver"></option>
        <option value="beige"></option>
        <option value="graphite"></option>
      </datalist>
    </div>
  </div>

  <!-- Ordered style -->
  <div class="row mt-8">
    <label class="small">Ordered style (Pt chose)</label>
    <input
      type="text"
      id="order-style"
      list="order-style-list"
      placeholder="e.g. behind-the-ear"
      style="max-width: 360px;"
    />
    <datalist id="order-style-list">
      <option value="behind-the-ear"></option>
      <option value="power behind-the-ear"></option>
      <option value="receiver-in-the-canal"></option>
      <option value="in-the-ear"></option>
      <option value="in-the-canal"></option>
      <option value="completely-in-the-canal"></option>
      <option value="invisible-in-the-canal"></option>
    </datalist>
  </div>

  <!-- Coupling & Receivers -->
  <h4 class="mt-16">Coupling & Receivers (order)</h4>

  <!-- Tube/receiver type -->
  <div class="row mt-6">
    <label class="small">Tube / receiver type</label>
    <div class="row">
      <button class="btn" data-ordertube="receiver">Receiver</button>
      <button class="btn" data-ordertube="slim tube">Slim tube</button>
    </div>
  </div>

  <!-- AS / AD receiver + mold inputs -->
  <div class="grid-2 mt-10">

    <!-- Left Ear -->
    <div>
      <div class="copy-arrows">
        <span class="small"><strong>Left (AS)</strong></span>
        <button class="btn" id="copy-coupling-AS-to-AD">Copy â–¶</button>
      </div>

      <label class="small mt-6">Receiver/slim tube length â€” AS</label>
      <select id="rec-len-AS">
        <option value="">â€”</option>
        <option>0</option><option>1</option><option>2</option>
        <option>3</option><option>4</option><option>5</option>
      </select>

      <label class="small mt-6">Receiver power (AS)</label>
      <input
        type="text"
        id="rec-pwr-AS"
        placeholder="e.g., 50"
      />

      <label class="small mt-6">Ear mold style (AS)</label>
      <select id="order-mold-type-AS">
        <option value="">â€”</option>
        <option value="canal">canal</option>
        <option value="canal lock">canal lock</option>
        <option value="half shell">half shell</option>
        <option value="full shell">full shell</option>
      </select>

      <label class="small mt-6">Ear mold material (AS)</label>
      <select id="order-mold-material-AS">
        <option value="">â€”</option>
        <option value="soft">soft</option>
        <option value="hard">hard</option>
        <option value="silicone">silicone</option>
        <option value="acrylic">acrylic</option>
      </select>

      <label class="small mt-6">Ear mold color (AS)</label>
      <input
        type="text"
        id="mold-color-AS"
        list="mold-color-list"
        placeholder="Left (AS)"
      />
    </div>

    <!-- Right Ear -->
    <div>
      <div class="copy-arrows">
        <span class="small"><strong>Right (AD)</strong></span>
        <!-- dummy button to match Copy â–¶ height on the left -->
        <button class="btn" style="visibility:hidden; pointer-events:none;">Copy â–¶</button>
      </div>

      <label class="small mt-6">Receiver/slim tube length â€” AD</label>
      <select id="rec-len-AD">
        <option value="">â€”</option>
        <option>0</option><option>1</option><option>2</option>
        <option>3</option><option>4</option><option>5</option>
      </select>

      <label class="small mt-6">Receiver power (AD)</label>
      <input
        type="text"
        id="rec-pwr-AD"
        placeholder="e.g., 60"
      />

      <label class="small mt-6">Ear mold style (AD)</label>
      <select id="order-mold-type-AD">
        <option value="">â€”</option>
        <option value="canal">canal</option>
        <option value="canal lock">canal lock</option>
        <option value="helix">helix</option>
        <option value="half shell">half shell</option>
        <option value="3/4 shell">3/4 shell</option>
        <option value="skeleton">skeleton</option>
        <option value="full shell">full shell</option>
      </select>

      <label class="small mt-6">Ear mold material (AD)</label>
      <select id="order-mold-material-AD">
        <option value="">â€”</option>
        <option value="soft">soft</option>
        <option value="hard">hard</option>
      </select>

      <label class="small mt-6">Ear mold color (AD)</label>
      <input
        type="text"
        id="mold-color-AD"
        list="mold-color-list"
        placeholder="Right (AD)"
      />
    </div>

  </div>

  <datalist id="mold-color-list">
    <option value="clear"></option>
    <option value="champagne"></option>
    <option value="brown"></option>
    <option value="black"></option>
    <option value="beige"></option>
  </datalist>

  <!-- Coupling style toggle buttons -->
  <div class="row mt-10">
    <label class="small">Coupling style (order)</label>
    <div class="row" id="order-coupling-row"></div>
  </div>

  <!-- Extra details -->
  <div class="row mt-10">
    <label class="small">Extra order details (live)</label>
    <textarea
      id="order-extra"
      rows="3"
      placeholder="e.g., Soft ear molds due to Ptâ€™s hearing loss."
    ></textarea>
  </div>

</div>

    <h4>Impressions</h4>
    <div class="row">
      <button class="btn" data-impression="taken">Impression</button>
      <button class="btn" data-impression="onfile">Imp on file</button>
    </div>

  </div>
</details>

    <div class="row" style="margin-top:8px;">
      <textarea id="custom-assessment" rows="3"
        placeholder="Additional Assessment info"></textarea>
    </div>

  </div>
</details>

<!-- PLAN -->
<details class="card" id="sec-plan" open>
  <summary>Plan <span class="chev">â–¶</span></summary>
  <div class="card-body" id="plan-body">

    <h4>Plan Items</h4>

    <div id="plan-items" class="row"></div>

    <h4>RTC Builder</h4>

    <div class="grid-3">

      <!-- TIME INPUT COLUMN -->
      <div>
        <label class="small">Timeframe</label>
        <input type="number" id="rtc-time" placeholder="e.g., 2"/>
      </div>

      <!-- UNIT BUTTONS COLUMN -->
      <div>
        <label class="small">Unit</label>
        <div class="row">
          <button class="btn" data-rtcunit="weeks">Week(s)</button>
          <button class="btn" data-rtcunit="months">Month(s)</button>
          <button class="btn" data-rtcunit="years">Year(s)</button>
        </div>
      </div>

      <!-- AS-NEEDED + CLEAR COLUMN -->
      <div>
        <label class="small">Other</label>
        <div class="row">
          <button class="btn" id="rtc-asneeded">or as needed</button>
          <button class="btn reset" id="rtc-clear">Clear RTC</button>
        </div>
      </div>

    </div>

    <div class="row" style="margin-top:8px;">
      <textarea id="custom-plan" rows="3"
        placeholder="Additional Plan info"></textarea>
    </div>

  </div>
</details>

</div> <!-- end LEFT column -->


<!-- RIGHT COLUMN -->
<div class="right">
  <div class="card">
    <header>Generated SOAP Note</header>
    <textarea id="noteArea" readonly></textarea>
    <div class="note-hint">This note updates automatically as you make selections.</div>

    <div class="note-controls">
      <button class="btn" id="copy-note">Copy Note</button>
      <button class="btn reset" id="clear-note">Clear Note</button>
    </div>

  </div>
</div>

</div><!-- END APP -->
</div><!-- END WRAP -->

<script>
/* ===============================================
   SOAP NOTE BUILDER â€” CLEAN BASE JS
   =============================================== */

window.SNB = (()=>{

  const S = {};
  const state = {

    /* SUBJECTIVE */
    apptType: '',
    companion: '',
    historyAS: new Set(),
    historyAD: new Set(),
    historyGeneral: new Set(),
    historyDeniesAll: false,
    historyAdditional: '',
    historyHAUse: '',

    repGenAS: new Set(),
    repGenAD: new Set(),
    repHAAS: new Set(),
    repHAAD: new Set(),

    repCustomAS: [],
    repCustomAD: [],
    subjCustom: [],

    /* OBJECTIVE */
    otoAScanal: new Set(),
    otoAStm: new Set(),
    otoADcanal: new Set(),
    otoADtm: new Set(),
    otoCustomAS: [],
    otoCustomAD: [],

    audioObjSrc: '',
    audioObjASdeg: new Set(),
    audioObjADdeg: new Set(),
    audioObjAStype: new Set(),
    audioObjADtype: new Set(),
    audioObjASconf: new Set(),
    audioObjADconf: new Set(),
    audioObjCustomAS: [],
    audioObjCustomAD: [],


    hacAS: new Set(),
    hacAD: new Set(),
    hacCustomAS: [],
    hacCustomAD: [],

    clearance: '',
    clearanceDoc: '',
    clearanceAS: false,
    clearanceAD: false,

    objCustom: [],


    /* ASSESSMENT */
    audioASdeg: new Set(),
    audioADdeg: new Set(),
    audioAStype: new Set(),
    audioADtype: new Set(),
    audioASconf: new Set(),
    audioADconf: new Set(),
    audioCustomAS: [],
    audioCustomAD: [],


    insCompany: '',
    insBenefit: '',
    insOOP: '',
    insurance: { status: null },

    haStyle: new Set(),
    haRecAS: false,           // left ear recommended?
    haRecAD: false,           // right ear recommended?
    haTech: '',               // "Hearing aid details" text
    haCoupling: new Set(),    // dome / custom ear mold
    orderCoupling: new Set(),

    order: {
      mfg: '',
      model: '',
      style: '',
      color: '',
      scope: '',              // AS, AD, or AU (also derived from buttons)

      // Receiver / tube details
      recLenAS: '',
      recLenAD: '',
      recPwrAS: '',
      recPwrAD: '',
      tubeType: '',           // "slim tube" or "receiver"

      // Ear mold style/material/color â€” independent per ear
      moldTypeAS: '',
      moldTypeAD: '',
      moldMaterialAS: '',
      moldMaterialAD: '',
      moldColorAS: '',
      moldColorAD: '',

      extraDetails: ''        // optional extra line for order
    },

    hamAS: new Set(),
    hamAD: new Set(),
    hamCustomAS: [],
    hamCustomAD: [],

    hamPostAS: new Set(),
    hamPostAD: new Set(),
    hamPostCustomAS: [],
    hamPostCustomAD: [],

    assessCustom: [],

    /* PLAN */
    planItems: new Set(),
    rtcTime: '',
    rtcUnit: '',
    rtcAsNeeded: false,
    planCustom: []
  };

  S.state = state;

  S.consts = {
    HIST_ASAD: [
      "decreased hearing",
      "tinnitus",
      { label: "sudden loss", value: "sudden hearing loss within the previous 90 days" },
      { label: "pain", value: "pain or discomfort in the ear" },
      { label: "drainage", value: "drainage from the ear" },
      "noise exposure",
      "head injury"
    ],
    HIST_GENERAL: [
      "vertigo/dizziness"
    ],
    REPORTS_GENERAL: [
      "decreased hearing"
    ],
    REPORTS_HA: [
      "working well","sounds weak","sounds dead","broken","needs a tube change","needs a reprogramming"
    ],
    OTO_CANAL: ["clear","non-occluding wax","occluding wax","redness","swelling","object in ear"],
    OTO_TM: ["normal","unremarkable","dull","retracted","bulging","red","scarred","perforated"],
     // ðŸ”¹ Hearing aid CONDITION (Objective)
    HAC_OPTS: [
        "appears clean",
        "appears dirty",
        "filters plugged",
        "filters appear partially plugged",
        "tubes soft",
        "tubes hard",
        "microphones appear clean",
        "microphones appear clogged",
        "case in good condition",
        "case shows cosmetic wear",
        "battery door intact",
        "battery door loose"
    ],

    // ðŸ”¹ Hearing aid MAINTENANCE (used later, Plan/Assessment section)
    HAM_OPTS: [
        "cleaned",
        "vacuumed microphones",
        "wax guard replaced",
        "tubing replaced",
        "dome replaced",
        "ear hook replaced",
        "receiver replaced",
        "battery replaced",
        "firmware updated"
    ],
    HAM_POST_OPTS: [
        "sounds good",
        "still sounds weak",
        "still sounds dead",
        "cannot fix in office",
        "needs to be sent for repair"],
    AUDIO_DEG: ["normal","mild","moderate","moderately-severe","severe","profound"],
    AUDIO_TYPE: ["sensorineural","conductive","mixed","rising","sloping","flat","cookie bite","high frequency"], // used elsewhere

    // For audiogram modules:
    AUDIO_TYPE_ONLY: ["sensorineural","conductive","mixed"],
    AUDIO_CONFIG: ["rising","sloping","flat","cookie bite","high frequency"],
HA_COUPLING: [
  { label: "Dome",        value: "dome" },
  { label: "Ear mold",    value: "ear mold" },
  { label: "RIC ear mold", value: "RIC ear mold" }
],
    
    HA_STYLES: [
      { label: "BTE",       value: "behind-the-ear" },
      { label: "Power BTE", value: "power behind-the-ear" },
      { label: "RIC",       value: "receiver-in-the-canal" },
      { label: "ITE",       value: "in-the-ear" },
      { label: "ITC",       value: "in-the-canal" },
      { label: "CIC",       value: "completely-in-the-canal" },
      { label: "IIC",       value: "invisible-in-the-canal" }
    ],

    PLAN_ITEMS: [
      { label: "PCP referral", value: "Follow up with PCP"},
      { label: "ENT referral", value: "Follow up with ENT"},
      { label: "Schedule HAE", value: "Schedule HAE"},
      { label: "hearing test", value: "Annual hearing tests"},
      { label: "ready submit order", value: "I will submit the order to the manufacturer with options noted above"},
      { label: "not ready submit order", value: "When auth is received, I will submit the order to the manufacturer with options noted above"},
      { label: "ready submit order +imps", value: "I will send impressions to the manufacturer with options noted above"},
      { label: "not ready submit order +imps", value: "When auth is received, I will send impressions to the manufacturer with options noted above"},
      { label: "delivery call", value: "RTC 4-6 weeks for a Delivery appt. We will call when the hearing aids are received"},
      { label: "delivery schedule", value: "RTC 4-6 weeks for a delivery appt."},
      { label: "think about it", value: "If patient wants to move forward with ordering hearing aids or if they have any other questions, they will contact us."},
      { label: "event list", value: "I will add patient to the event candidate list."},
      { label: "eligible new", value: "Pt may be eligible for new HAâ€™s, RTC for an annual hearing test to start the process"},
    ]
  };

  S.utils = {
    joinAnd(arr){
      if(!arr.length) return '';
      if(arr.length === 1) return arr[0];
      if(arr.length === 2) return arr[0] + ' and ' + arr[1];
      return arr.slice(0,-1).join(', ') + ', and ' + arr[arr.length-1];
    },
    joinOr(arr){
      if(!arr.length) return '';
      if(arr.length === 1) return arr[0];
      if(arr.length === 2) return arr[0] + ' or ' + arr[1];
      return arr.slice(0,-1).join(', ') + ', or ' + arr[arr.length-1];
    }
  };

  // Reset all state values without breaking existing Set/Array references
  function resetState(){
    // Clear Sets and Arrays, reset primitives
    for (const [key, value] of Object.entries(state)){
      if (value instanceof Set){
        value.clear();
      } else if (Array.isArray(value)){
        value.length = 0;
      } else if (typeof value === 'string'){
        state[key] = '';
      } else if (typeof value === 'boolean'){
        state[key] = false;
      } else if (typeof value === 'number'){
        // we use numbers mostly like strings; reset to empty
        state[key] = '';
      }
      // Objects (like order, insurance) are handled explicitly below
    }

    // Reset nested ORDER object
    Object.assign(state.order, {
      mfg: '',
      model: '',
      style: '',
      color: '',
      scope: '',

      recLenAS: '',
      recLenAD: '',
      recPwrAS: '',
      recPwrAD: '',
      tubeType: '',

      moldTypeAS: '',
      moldTypeAD: '',
      moldMaterialAS: '',
      moldMaterialAD: '',
      moldColorAS: '',
      moldColorAD: '',

      extraDetails: ''
    });

    // Reset nested INSURANCE object
    state.insurance.status = null;
  }


  /* ============================
     HISTORY TEXT LOGIC
     ============================ */
  function historyText(){
    const as = [...state.historyAS];
    const ad = [...state.historyAD];
    const gen = [...state.historyGeneral];
    const allRaw = [...S.consts.HIST_ASAD, ...S.consts.HIST_GENERAL];
const all = [];
allRaw.forEach(opt=>{
  const v = (opt && opt.value) || opt;  // use .value for objects, string as-is
  if(!all.includes(v)) all.push(v);
});

    const anyOn = as.length || ad.length || gen.length;

    if(state.historyDeniesAll){
      const out = [`Denies history of ${all.join(', ')}.`];
      if(state.historyHAUse.trim()){
        out.push(`History of hearing aid use: ${state.historyHAUse.trim()}.`);
      }
      return out;
    }

    const parts = [];
    const asStr = S.utils.joinAnd(as);
    const adStr = S.utils.joinAnd(ad);

    if(asStr || adStr){
      if(asStr && adStr && asStr===adStr){
        parts.push(`${asStr} AU`);
      } else {
        if(asStr) parts.push(`${asStr} AS`);
        if(adStr) parts.push(`${adStr} AD`);
      }
    }

    if(gen.length) parts.push(S.utils.joinAnd(gen));
    if(state.historyAdditional.trim())
      parts.push(state.historyAdditional.trim());

    const out = [];
    if(parts.length){
      out.push(`History of ${parts.join('; ')}.`);
    }

    if(anyOn){
      const denies = all.filter(x=>!(as.includes(x) || ad.includes(x) || gen.includes(x)));
      if(denies.length)
        out.push(`Denies history of ${denies.join(', ')}.`);
    }

    if(state.historyHAUse.trim())
      out.push(`History of hearing aid use: ${state.historyHAUse.trim()}.`);

    return out;
  }

 
    /* ============================
     RENDER NOTE (FULL SOAP FORMAT)
     ============================ */
  S.rebuild = function(){

    const linesS = [];   // Subjective
    const linesO = [];   // Objective
    const linesA = [];   // Assessment
    const linesP = [];   // Plan

    /* ============================
       SUBJECTIVE
       ============================ */

    if(state.apptType){
      const aOrAn = /^[aeiou]/i.test(state.apptType) ? 'an' : 'a';
      const comp = state.companion ? ` with ${state.companion}` : '';
      linesS.push(`The patient is here for ${aOrAn} ${state.apptType}${comp}.`);
    }

    // History block (with denies logic)
    linesS.push(...historyText());

// Patient Reports
const genAS = [...state.repGenAS];
const genAD = [...state.repGenAD];
const haAS  = [...state.repHAAS];
const haAD  = [...state.repHAAD];

// General (nonâ€“hearing-aid) reports â€“ single line
if(genAS.length || genAD.length){
  const sameGen =
    genAS.length && genAD.length &&
    genAS.length === genAD.length &&
    genAS.every(v => genAD.includes(v));

  if(sameGen){
    const phrase = S.utils.joinAnd(genAS);
    // Example: "Patient reports decreased hearing AU."
    linesS.push(`Patient reports ${phrase} AU.`);
  } else {
    const parts = [];
    if(genAS.length) parts.push(`${S.utils.joinAnd(genAS)} AS`);
    if(genAD.length) parts.push(`${S.utils.joinAnd(genAD)} AD`);
    // Example: "Patient reports decreased hearing AS; tinnitus AD."
    linesS.push(`Patient reports ${parts.join('; ')}.`);
  }
}

// Hearing-aid related reports â€“ separate line
if(haAS.length || haAD.length){
  const sameHA =
    haAS.length && haAD.length &&
    haAS.length === haAD.length &&
    haAS.every(v => haAD.includes(v));

  if(sameHA){
    const phrase = S.utils.joinAnd(haAS);
    // Example: "Patient reports hearing aids working well AU."
    linesS.push(`Patient reports hearing aids ${phrase} AU.`);
  } else {
    const parts = [];
    if(haAS.length) parts.push(`hearing aid ${S.utils.joinAnd(haAS)} AS`);
    if(haAD.length) parts.push(`hearing aid ${S.utils.joinAnd(haAD)} AD`);
    // Example: "Patient reports hearing aid working well AS; hearing aid sounds weak AD."
    linesS.push(`Patient reports ${parts.join('; ')}.`);
  }
}

// Global subjective custom lines
if(state.subjCustom.length)
  state.subjCustom.forEach(l=>linesS.push(l.endsWith('.')?l:l+'.'));


    /* ============================
       OBJECTIVE
       ============================ */

    // ðŸ”¹ Otoscopy â€“ 1 line per ear: Canal + TM + custom
    const canalAS = [...state.otoAScanal];
    const tmAS    = [...state.otoAStm];
    const canalAD = [...state.otoADcanal];
    const tmAD    = [...state.otoADtm];

    if(canalAS.length || tmAS.length || state.otoCustomAS.length){
      const partsAS = [];
      if(canalAS.length) partsAS.push(`Canal: ${S.utils.joinAnd(canalAS)}`);
      if(tmAS.length)    partsAS.push(`TM: ${S.utils.joinAnd(tmAS)}`);
      if(state.otoCustomAS.length){
        const customAS = state.otoCustomAS
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
        partsAS.push(customAS);
      }
      linesO.push(`Otoscopy (AS): ${partsAS.join('; ')}`);
    }

    if(canalAD.length || tmAD.length || state.otoCustomAD.length){
      const partsAD = [];
      if(canalAD.length) partsAD.push(`Canal: ${S.utils.joinAnd(canalAD)}`);
      if(tmAD.length)    partsAD.push(`TM: ${S.utils.joinAnd(tmAD)}`);
      if(state.otoCustomAD.length){
        const customAD = state.otoCustomAD
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
        partsAD.push(customAD);
      }
      linesO.push(`Otoscopy (AD): ${partsAD.join('; ')}`);
    }

    // Outside audiogram â€“ single sentence, AU when ears match
    const prefix = state.audioObjSrc
      ? `Audiogram from ${state.audioObjSrc}`
      : `Audiogram`;

    function buildAudioObjEarDesc(degSet, typeSet, confSet, customArr){
      const order = S.consts.AUDIO_DEG;
      const degVals = Array.from(degSet);
      degVals.sort((a,b)=>order.indexOf(a)-order.indexOf(b));

      const typeVals = Array.from(typeSet);
      const typeVal = typeVals[0] || '';

      const confVals = Array.from(confSet);
      const confVal = confVals[0] || '';

      const hasDegree = degVals.length > 0;
      const hasType   = !!typeVal;
      const hasConf   = !!confVal;
      const hasCustom = !!(customArr && customArr.length);

      // If absolutely nothing selected/typed, return empty â†’ no line in note
      if(!hasDegree && !hasType && !hasConf && !hasCustom){
        return '';
      }

      // Custom-only case: no degree/type/config, but user typed something
      if(!hasDegree && !hasType && !hasConf && hasCustom){
        return customArr
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
      }

      let degreePhrase = '';
      if(degVals.length === 1){
        degreePhrase = degVals[0];
      } else if(degVals.length >= 2){
        degreePhrase = `${degVals[0]} to ${degVals[1]}`;
      }

      const pieces = [];

      // Special case: ONLY "normal" selected, no type/config -> "hearing is within normal limits"
      if(degVals.length === 1 && degVals[0] === 'normal' && !hasType && !hasConf){
        pieces.push('hearing is within normal limits');
      } else {
      
        // Build the core "hearing loss" phrase
        let core = '';

        if(degreePhrase){
          if(hasConf && hasType){
            // mild to moderate sloping sensorineural hearing loss
            core = `${degreePhrase} ${confVal} ${typeVal} hearing loss`;
          } else if(hasConf){
            // mild to moderate sloping hearing loss
            core = `${degreePhrase} ${confVal} hearing loss`;
          } else if(hasType){
            // mild to moderate sensorineural hearing loss
            core = `${degreePhrase} ${typeVal} hearing loss`;
          } else {
            // mild to moderate hearing loss
            core = `${degreePhrase} hearing loss`;
          }
        } else {
          // No degree selected, fall back to type/config if present
          if(hasConf && hasType){
            core = `${confVal} ${typeVal} hearing loss`;
          } else if(hasType){
            core = `${typeVal} hearing loss`;
          } else if(hasConf){
            core = `${confVal} hearing loss`;
          } else {
            // We get here only if there was some non-empty state,
            // but no degree/type/config â€” this shouldn't really happen
            core = `hearing loss`;
          }
        }

        if(core) pieces.push(core);
      }

      if(hasCustom){
        const customText = customArr
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
        pieces.push(customText);
      }

      return pieces.join(', ');
    }

    const aObjAS = buildAudioObjEarDesc(
      state.audioObjASdeg,
      state.audioObjAStype,
      state.audioObjASconf,
      state.audioObjCustomAS
    );
    const aObjAD = buildAudioObjEarDesc(
      state.audioObjADdeg,
      state.audioObjADtype,
      state.audioObjADconf,
      state.audioObjCustomAD
    );

    if(aObjAS || aObjAD){
      if(aObjAS && aObjAD && aObjAS === aObjAD){
        // Example: "Audiogram from Dr. X shows moderate to severe hearing loss, AU."
        linesO.push(`${prefix} shows ${aObjAS}, AU.`);
      } else {
        const parts = [];
        if(aObjAS) parts.push(`${aObjAS}, AS`);
        if(aObjAD) parts.push(`${aObjAD}, AD`);
        linesO.push(`${prefix} shows ${parts.join('; ')}.`);
      }
    }
    // ðŸ”¹ Medical Clearance â€“ single line, uses Doctor + AS/AD/AU
    if(state.clearance){
      const status = state.clearance === 'received' ? 'received' : 'not received';
      const asOn = !!state.clearanceAS;
      const adOn = !!state.clearanceAD;

      let scope = '';
      if(asOn && adOn) scope = 'AU';
      else if(asOn)    scope = 'AS';
      else if(adOn)    scope = 'AD';

      let line = 'Medical clearance ';

      if(status === 'received'){
        line += 'received';
        if(state.clearanceDoc) line += ` by ${state.clearanceDoc}`;
      } else {
        line += 'not received';
        if(state.clearanceDoc) line += ` from ${state.clearanceDoc}`;
      }

      if(scope){
        const aidsWord = (scope === 'AU') ? 'hearing aids' : 'a hearing aid';
        line += ` for ${aidsWord}, ${scope}.`;
      } else {
        line += '.';
      }

      linesO.push(line);
    } else if(state.clearanceDoc){
      // Fallback if someone only fills the doctor
      linesO.push(`Medical clearance from ${state.clearanceDoc}.`);
    }

    // ðŸ”¹ Hearing Aid Condition â€“ single line, AU if same
    const hacAS = [...state.hacAS];
    const hacAD = [...state.hacAD];

    if(hacAS.length || hacAD.length){
      const sameHAC =
        hacAS.length && hacAD.length &&
        hacAS.length === hacAD.length &&
        hacAS.every(v => hacAD.includes(v));

      if(sameHAC){
        const cond = S.utils.joinAnd(hacAS);
        // Example: "Hearing aid condition: appears clean, AU."
        linesO.push(`Hearing aid condition: ${cond}, AU.`);
      } else {
        const parts = [];
        if(hacAS.length) parts.push(`${S.utils.joinAnd(hacAS)}, AS`);
        if(hacAD.length) parts.push(`${S.utils.joinAnd(hacAD)}, AD`);
        linesO.push(`Hearing aid condition: ${parts.join('; ')}.`);
      }
    }
    // (hacCustomAS/AD no longer output here â€“ boxes were removed)


    // ðŸ”¹ Custom Objective
    if(state.objCustom.length)
      state.objCustom.forEach(l=>linesO.push(l.endsWith('.')?l:l+'.'));



    /* ============================
       ASSESSMENT
       ============================ */

    // In-office audiogram â€“ same behavior as outside audiogram
    const inPrefix = 'Audiogram';

    function buildAudioEarDesc(degSet, typeSet, confSet, customArr){
      const order = S.consts.AUDIO_DEG;
      const degVals = Array.from(degSet);
      degVals.sort((a,b)=>order.indexOf(a)-order.indexOf(b));

      const typeVals = Array.from(typeSet);
      const typeVal = typeVals[0] || '';

      const confVals = Array.from(confSet);
      const confVal = confVals[0] || '';

      const hasDegree = degVals.length > 0;
      const hasType   = !!typeVal;
      const hasConf   = !!confVal;
      const hasCustom = !!(customArr && customArr.length);

      // If absolutely nothing selected/typed, return empty â†’ no line in note
      if(!hasDegree && !hasType && !hasConf && !hasCustom){
        return '';
      }

      // Custom-only case: no degree/type/config, but user typed something
      if(!hasDegree && !hasType && !hasConf && hasCustom){
        return customArr
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
      }

      let degreePhrase = '';
      if(degVals.length === 1){
        degreePhrase = degVals[0];
      } else if(degVals.length >= 2){
        degreePhrase = `${degVals[0]} to ${degVals[1]}`;
      }

      const pieces = [];

      // Special case: ONLY "normal" selected, no type/config -> "hearing is within normal limits"
      if(degVals.length === 1 && degVals[0] === 'normal' && !hasType && !hasConf){
        pieces.push('hearing is within normal limits');
      } else {
      
        let core = '';

        if(degreePhrase){
          if(hasConf && hasType){
            core = `${degreePhrase} ${confVal} ${typeVal} hearing loss`;
          } else if(hasConf){
            core = `${degreePhrase} ${confVal} hearing loss`;
          } else if(hasType){
            core = `${degreePhrase} ${typeVal} hearing loss`;
          } else {
            core = `${degreePhrase} hearing loss`;
          }
        } else {
          if(hasConf && hasType){
            core = `${confVal} ${typeVal} hearing loss`;
          } else if(hasType){
            core = `${typeVal} hearing loss`;
          } else if(hasConf){
            core = `${confVal} hearing loss`;
          } else {
            core = `hearing loss`;
          }
        }

        if(core) pieces.push(core);
      }

      if(hasCustom){
        const customText = customArr
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
        pieces.push(customText);
      }

      return pieces.join(', ');
    }

    const inAS = buildAudioEarDesc(
      state.audioASdeg,
      state.audioAStype,
      state.audioASconf,
      state.audioCustomAS
    );
    const inAD = buildAudioEarDesc(
      state.audioADdeg,
      state.audioADtype,
      state.audioADconf,
      state.audioCustomAD
    );

    if(inAS || inAD){
      // Same description both ears (AU)
      if(inAS && inAD && inAS === inAD){
        if(inAS === 'hearing is within normal limits'){
          // Normal both ears
          linesA.push(`Audiogram was performed today. Results indicate hearing is within normal limits.`);
        } else {
          // Hearing loss, AU
          const needsArticle = /hearing loss\b/.test(inAS);
          const core = needsArticle ? `a ${inAS}` : inAS;
          linesA.push(`Audiogram was performed today. Results indicate ${core}, AU.`);
        }
      } else {
        // AS / AD different or only one ear documented
        const parts = [];
        if(inAS) parts.push(`${inAS}, AS`);
        if(inAD) parts.push(`${inAD}, AD`);

        const joined = parts.join('; ');

        // Add "a" only if it's a single-ear phrase with "hearing loss"
        let prefixArticle = '';
        if((inAS && !inAD) || (!inAS && inAD)){
          if(/hearing loss\b/.test(joined)){
            prefixArticle = 'a ';
          }
        }

        linesA.push(`Audiogram was performed today. Results indicate ${prefixArticle}${joined}.`);
      }
    }


    // Insurance
    if(state.insCompany) linesA.push(`Insurance: ${state.insCompany}.`);
    if(state.insBenefit) linesA.push(`Benefit: ${state.insBenefit}.`);
    if(state.insOOP)     linesA.push(`Out-of-pocket: ${state.insOOP}.`);
    if(state.insurance.status)
      linesA.push(`Authorization: ${state.insurance.status}.`);

// =====================
// HA RECOMMENDATION & PATIENT ORDER
// =====================

// --- Recommendation scope (AS/AD -> AU) ---
let recScope = '';
if(state.haRecAS && state.haRecAD) recScope = 'AU';
else if(state.haRecAS)             recScope = 'AS';
else if(state.haRecAD)             recScope = 'AD';

let recScopeFull = recScope;

const styles = [...state.haStyle]; // values from HA_STYLES, e.g. "behind-the-ear"

let stylePhrase = '';
if(styles.length === 1){
  // e.g. "behind-the-ear style"
  stylePhrase = `${styles[0]} style`;
} else if(styles.length > 1){
  // e.g. "behind-the-ear style or receiver-in-the-canal style"
  const styleWithWord = styles.map(s => `${s} style`);
  stylePhrase = S.utils.joinOr(styleWithWord);
}

// --- Coupling for recommendation (dome / ear mold / RIC ear mold) ---
const cvals = [...state.haCoupling]; // 'dome', 'ear mold', 'RIC ear mold'

let couplingPhrase = '';
if(cvals.length){
  const phrases = [];

  cvals.forEach(v=>{
    if(v === 'dome'){
      phrases.push('a dome');
    } else if(v === 'ear mold' || v === 'RIC ear mold'){
      // both map to "an ear mold" for the rec sentence
      phrases.push('an ear mold');
    }
  });

  // de-dupe (so dome + ear mold doesn't yield "an ear mold, an ear mold, a dome")
  const unique = [...new Set(phrases)];

  if(unique.length === 1){
    couplingPhrase = unique[0];           // e.g. "an ear mold"
  } else if(unique.length > 1){
    couplingPhrase = S.utils.joinOr(unique); // e.g. "an ear mold or a dome"
  }
}

// --- HA details (manufacturer / model / tech level) ---
let recPrefix = '';
if(state.haTech && stylePhrase){
  // e.g. "I recommend the Starkey Evolv AI 1000 behind-the-ear or receiver-in-the-canal styles"
  recPrefix = `I recommend the ${state.haTech} ${stylePhrase}`;
} else if(state.haTech){
  // fallback: no styles selected
  recPrefix = `I recommend the ${state.haTech}`;
} else if(stylePhrase){
  recPrefix = `I recommend ${stylePhrase}`;
}

// --- Final recommendation line ---
if(recPrefix){
  let recLine = recPrefix;
  if(couplingPhrase){
    recLine += ` with ${couplingPhrase}`;
  }
  if(recScopeFull){
    recLine += `, ${recScopeFull}.`;
  } else {
    recLine += `.`;
  }
  linesA.push(recLine);
}

// PATIENT ORDER LINES
// =====================
const o = state.order;

// Build "Pt chose ..." line with style/material & AS/AD/AU logic
(function buildPatientChoseLine(){
  const cv = [...state.orderCoupling];

  const hasOrderCore =
    o.mfg || o.model || o.style || o.color ||
    o.moldType || o.moldMaterial ||
    o.moldColorAS || o.moldColorAD ||
    cv.length;

  if(!hasOrderCore) return;

  const scope = o.scope; // '', 'AS', 'AD', 'AU'

  let line = 'Pt chose ';

  // Brand + model
  const brandModel = [o.mfg, o.model].filter(Boolean).join(' ').trim();
  if(brandModel){
    line += brandModel + ' ';
  }

  // Style (e.g. "receiver-in-the-canal")
  if(o.style && o.style.trim()){
    line += o.style.trim() + ' ';
  }

  // Hearing aid(s)
  if(scope === 'AU'){
    line += 'hearing aids';
  } else {
    line += 'hearing aid';
  }

  // Color of HA shell
  if(o.color && o.color.trim()){
    line += ` in â€œ${o.color.trim()}â€`;
  }

  // Coupling / ear molds
  let withPhrase = '';

  if(cv.length){
    const couplingType = cv[0]; // assume one selection
    const leftColor  = o.moldColorAS && o.moldColorAS.trim();
    const rightColor = o.moldColorAD && o.moldColorAD.trim();

    const moldType     = o.moldType && o.moldType.trim();       // e.g. "half shell"
    const moldMaterial = o.moldMaterial && o.moldMaterial.trim(); // e.g. "soft"

    // Helper to build a descriptive ear mold base (without color)
    function buildMoldBase(isRIC){
      let base = '';
      if(moldMaterial) base += moldMaterial + ' ';
      if(moldType)     base += moldType + ' ';
      if(isRIC)        base += 'RIC ';
      base += 'ear molds';
      return base.trim();
    }

    if(couplingType === 'dome'){
      // Simple domes, no mold style
      withPhrase = 'domes';
    } else if(couplingType === 'ear mold' || couplingType === 'RIC ear mold'){
      const isRIC = (couplingType === 'RIC ear mold');
      const base = buildMoldBase(isRIC); // e.g. "soft half shell RIC ear molds"

      if(leftColor && rightColor &&
         leftColor.toLowerCase() === rightColor.toLowerCase()){
        // Same color both ears â†’ compress
        withPhrase = `${base} in â€œ${leftColor}â€`;
      } else if(leftColor || rightColor){
        // Different per-ear colors
        const parts = [];
        if(leftColor){
          parts.push(
            base.replace('ear molds','ear mold')
                .replace('RIC ear mold','RIC ear mold')  // safety
                .replace('ear molds','ear mold') + ` in â€œ${leftColor}â€ (AS)`
          );
        }
        if(rightColor){
          parts.push(
            base.replace('ear molds','ear mold') + ` in â€œ${rightColor}â€ (AD)`
          );
        }
        withPhrase = parts.join(', ');
      } else {
        // No mold color, just describe style/material
        withPhrase = base;
      }
    } else {
      // Any future coupling types
      withPhrase = couplingType;
    }
  }

  if(withPhrase){
    line += `, with ${withPhrase}`;
  }

  // Scope suffix at end
  if(scope === 'AS'){
    line += ', AS.';
  } else if(scope === 'AD'){
    line += ', AD.';
  } else if(scope === 'AU'){
    line += ', AU.';
  } else {
    line += '.';
  }

  linesA.push(line);
})();

// Receiver / slim tube order line with AU vs AS/AD logic
(function buildReceiverOrderLine(){
  if(!o.tubeType) return;

  const hasRecAS = (o.recLenAS || o.recPwrAS);
  const hasRecAD = (o.recLenAD || o.recPwrAD);

  if(!hasRecAS && !hasRecAD) return;

  const isSlim = (o.tubeType === 'slim tube');

  // Helper to build per-ear detail
  function buildRecDetails(len, pwr){
    const bits = [];
    if(len) bits.push(`length #${len}`);
    if(pwr) bits.push(`${pwr} gain`);
    return bits.join(', ');
  }

  // If both ears have identical receiver data, use AU
  if(
    hasRecAS && hasRecAD &&
    o.recLenAS === o.recLenAD &&
    o.recPwrAS === o.recPwrAD
  ){
    const details = buildRecDetails(o.recLenAS, o.recPwrAS);
    const noun = isSlim ? 'slim tubes' : 'receivers';

    let line = `I will order ${noun}`;
    if(details) line += ` (${details})`;
    line += ', AU.';

    linesA.push(line);
    return;
  }

  // Otherwise, specify AS and AD separately
  const parts = [];
  if(hasRecAS){
    const details = buildRecDetails(o.recLenAS, o.recPwrAS);
    const noun = isSlim ? 'slim tube' : 'receiver';
    parts.push(`AS: ${details ? details + ' ' + noun : noun}`);
  }
  if(hasRecAD){
    const details = buildRecDetails(o.recLenAD, o.recPwrAD);
    const noun = isSlim ? 'slim tube' : 'receiver';
    parts.push(`AD: ${details ? details + ' ' + noun : noun}`);
  }

  const pluralNoun = isSlim ? 'slim tubes' : 'receivers';
  let line = `I will order ${pluralNoun}`;
  if(parts.length){
    line += ` (${parts.join('; ')}).`;
  } else {
    line += '.';
  }

  linesA.push(line);
})();

// Extra order details
if(o.extraDetails && o.extraDetails.trim()){
  linesA.push(`Additional order details: ${o.extraDetails.trim()}.`);
}
// =====================
// IMPRESSION LINE
// =====================
if(state.impressionStatus === 'taken'){
  linesA.push(`I took impressions without complication.`);
}
if(state.impressionStatus === 'onfile'){
  linesA.push(`I did not take impressions; we will order with impressions on file.`);
}

    // HA maintenance (options + custom on same line)
    function maintDesc(set, customArr){
      const parts = [];
      const arr = [...set];
      if(arr.length) parts.push(S.utils.joinAnd(arr));
      if(customArr && customArr.length){
        const customText = customArr
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
        parts.push(customText);
      }
      return parts.join('; ');
    }

    const hmAS = maintDesc(state.hamAS, state.hamCustomAS);
    const hmAD = maintDesc(state.hamAD, state.hamCustomAD);

    if(hmAS || hmAD){
      if(hmAS && hmAD && hmAS === hmAD){
        linesA.push(`Hearing aid maintenance: ${hmAS} AU.`);
      } else {
        const parts = [];
        if(hmAS) parts.push(`${hmAS} AS`);
        if(hmAD) parts.push(`${hmAD} AD`);
        linesA.push(`Hearing aid maintenance: ${parts.join('; ')}.`);
      }
    }

    // HA post-maintenance (options + custom on same line)
    function postMaintDesc(set, customArr){
      const parts = [];
      const arr = [...set];
      if(arr.length) parts.push(S.utils.joinAnd(arr));
      if(customArr && customArr.length){
        const customText = customArr
          .map(l=>l.endsWith('.')?l:l+'.')
          .join(' ');
        parts.push(customText);
      }
      return parts.join('; ');
    }

    const hpmAS = postMaintDesc(state.hamPostAS, state.hamPostCustomAS);
    const hpmAD = postMaintDesc(state.hamPostAD, state.hamPostCustomAD);

    if(hpmAS || hpmAD){
      if(hpmAS && hpmAD && hpmAS === hpmAD){
        linesA.push(`Post-maintenance status: ${hpmAS} AU.`);
      } else {
        const parts = [];
        if(hpmAS) parts.push(`${hpmAS} AS`);
        if(hpmAD) parts.push(`${hpmAD} AD`);
        linesA.push(`Post-maintenance status: ${parts.join('; ')}.`);
      }
    }

    // Global custom Assessment lines (from "Additional Assessment info")
    if (state.assessCustom && state.assessCustom.length){
      state.assessCustom.forEach(l => {
        if(!l || !l.trim()) return;
        const t = l.trim();
        linesA.push(t.endsWith('.') ? t : t + '.');
      });
    }

    /* ============================
       PLAN
       ============================ */

    const pl = [...state.planItems];

    // Each plan item gets its own bullet line
    if (pl.length) {
      pl.forEach(item => {
        linesP.push(item.endsWith('.') ? item : item + '.');
      });
    }

    // RTC logic:
    // - Timeframe only -> "RTC in 4 months."
    // - As needed only -> "RTC as needed."
    // - Both -> "RTC in 4 months or as needed."
    if (state.rtcTime && state.rtcUnit) {
      let rtcLine = `RTC in ${state.rtcTime} ${state.rtcUnit}`;
      if (state.rtcAsNeeded) {
        rtcLine += ' or as needed';
      }
      rtcLine += '.';
      linesP.push(rtcLine);
    } else if (state.rtcAsNeeded) {
      linesP.push('RTC as needed.');
    }

    if (state.planCustom.length)
      state.planCustom.forEach(l => linesP.push(l.endsWith('.') ? l : l + '.'));


    /* ============================
       FINAL NOTE OUTPUT
       ============================ */

    const NL = "\n";

    const finalNote =
      ''+NL+
      'Subjective:'+NL+
      (linesS.length ? linesS.map(l=>'- '+l).join(NL) : '')+NL+NL+
      'Objective:'+NL+
      (linesO.length ? linesO.map(l=>'- '+l).join(NL) : '')+NL+NL+
      'Assessment:'+NL+
      (linesA.length ? linesA.map(l=>'- '+l).join(NL) : '')+NL+NL+
      'Plan:'+NL+
      (linesP.length ? linesP.map(l=>'- '+l).join(NL) : '');

    const ta=document.getElementById('noteArea');
    const nearBottom = (ta.scrollTop + ta.clientHeight) >= (ta.scrollHeight - 10);
    const prev = ta.scrollTop;
    ta.value = finalNote;
    if(nearBottom) ta.scrollTop = ta.scrollHeight;
    else ta.scrollTop = prev;

    return finalNote;
  };

  /* ============================
     HELPERS
     ============================ */

  S.maxSelect = {
    // Outside audiogram (Objective)
    'audio-obj-AS-deg': 2,
    'audio-obj-AD-deg': 2,
    'audio-obj-AS-type': 1,
    'audio-obj-AD-type': 1,
    'audio-obj-AS-conf': 1,
    'audio-obj-AD-conf': 1,

    // In-office audiogram (Assessment)
    'audio-AS-deg': 2,
    'audio-AD-deg': 2,
    'audio-AS-type': 1,
    'audio-AD-type': 1,
    'audio-AS-conf': 1,
    'audio-AD-conf': 1,

    // HA coupling â€“ usually one choice
    'ha-coupling-row': 2
  };

  function makeButtons(containerID, options, set){
    const el = document.getElementById(containerID);
    if(!el) return;
    el.innerHTML = '';

    const max = S.maxSelect && S.maxSelect[containerID];

    options.forEach(opt=>{
      const b = document.createElement('button');
      b.className = 'btn';

      // Support both string and object
      const label = opt.label || opt;
      const value = opt.value || opt;

      if(set.has(value)) b.classList.add('toggled');
      b.textContent = label;

      b.addEventListener('click', ()=>{
        if(set.has(value)){
          // Turn OFF
          set.delete(value);
          b.classList.remove('toggled');
        } else {
          if(max === 1){
            // Single-select: clear others, select this one
            set.clear();
            el.querySelectorAll('.btn.toggled')
              .forEach(x=>x.classList.remove('toggled'));
            set.add(value);
            b.classList.add('toggled');
          } else {
            // Multi-select with optional cap
            if(max && set.size >= max) return; // already at cap
            set.add(value);
            b.classList.add('toggled');
          }
        }
        S.rebuild();
      });

      el.appendChild(b);
    });
  }

  function copySet(from, to){
    to.clear();
    from.forEach(v=>to.add(v));
  }

  function wireLiveTextarea(id, stateKey){
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', ()=>{
      state[stateKey] = el.value
        .split('\n')
        .map(s=>s.trim())
        .filter(Boolean);
      S.rebuild();
    });
  }


  /* ============================
     WIRE SUBJECTIVE
     ============================ */
  function wireSubjective(){

    const apptRow = document.getElementById('apptButtons');
    if(apptRow){
      apptRow.addEventListener('click', e=>{
        const b = e.target.closest('button[data-appt]');
        if(!b) return;
        const v = b.dataset.appt;
        state.apptType = (state.apptType === v) ? '' : v;
        apptRow.querySelectorAll('.btn').forEach(x=>{
          x.classList.toggle('toggled', x === b && state.apptType === v);
        });
        S.rebuild();
      });
    }

    const comp = document.getElementById('subjective-companion');
    if(comp){
      comp.addEventListener('input', ()=>{
        state.companion = comp.value.trim();
        S.rebuild();
      });
    }

    /* History buttons */
    makeButtons('hist-AS', S.consts.HIST_ASAD, state.historyAS);
    makeButtons('hist-AD', S.consts.HIST_ASAD, state.historyAD);
    makeButtons('hist-general', S.consts.HIST_GENERAL, state.historyGeneral);

    const histCopy = document.querySelector('[data-copy="hist-AS-to-AD"]');
    if(histCopy){
      histCopy.addEventListener('click', ()=>{
        copySet(state.historyAS, state.historyAD);
        makeButtons('hist-AD', S.consts.HIST_ASAD, state.historyAD);
        S.rebuild();
      });
    }

    const histAdd = document.getElementById('hist-additional');
    if(histAdd){
      histAdd.addEventListener('input', ()=>{
        state.historyAdditional = histAdd.value.trim();
        S.rebuild();
      });
    }

    const histHA = document.getElementById('hist-hause');
    if(histHA){
      histHA.addEventListener('input', ()=>{
        state.historyHAUse = histHA.value.trim();
        S.rebuild();
      });
    }

    /* Clicking any history button turns off "Denies all" */
    ['hist-AS','hist-AD','hist-general'].forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('click', ()=>{
        if(state.historyDeniesAll){
          state.historyDeniesAll = false;
          const btn = document.getElementById('btn-history-all');
          if(btn) btn.classList.remove('toggled');
          S.rebuild();
        }
      });
    });

    const btnAll = document.getElementById('btn-history-all');
    const btnClear = document.getElementById('btn-history-clear');

    if(btnAll){
      btnAll.addEventListener('click', ()=>{
        state.historyDeniesAll = !state.historyDeniesAll;
        btnAll.classList.toggle('toggled', state.historyDeniesAll);
        S.rebuild();
      });
    }

    if(btnClear){
      btnClear.addEventListener('click', ()=>{
        state.historyAS.clear();
        state.historyAD.clear();
        state.historyGeneral.clear();
        state.historyDeniesAll = false;
        state.historyAdditional = '';
        state.historyHAUse = '';

        ['hist-additional','hist-hause'].forEach(id=>{
          const el = document.getElementById(id);
          if(el) el.value = '';
        });

        document.querySelectorAll('#hist-AS .btn,#hist-AD .btn,#hist-general .btn')
          .forEach(b=>b.classList.remove('toggled'));
        if(btnAll) btnAll.classList.remove('toggled');

        S.rebuild();
      });
    }

    /* Patient Reports buttons */
    makeButtons('reports-gen-AS', S.consts.REPORTS_GENERAL, state.repGenAS);
    makeButtons('reports-gen-AD', S.consts.REPORTS_GENERAL, state.repGenAD);
    makeButtons('reports-ha-AS', S.consts.REPORTS_HA, state.repHAAS);
    makeButtons('reports-ha-AD', S.consts.REPORTS_HA, state.repHAAD);

    const rgenCopy = document.querySelector('[data-copy="rgen-AS-to-AD"]');
    if(rgenCopy){
      rgenCopy.addEventListener('click', ()=>{
        copySet(state.repGenAS, state.repGenAD);
        makeButtons('reports-gen-AD', S.consts.REPORTS_GENERAL, state.repGenAD);
        S.rebuild();
      });
    }
    const rhaCopy = document.querySelector('[data-copy="rha-AS-to-AD"]');
    if(rhaCopy){
      rhaCopy.addEventListener('click', ()=>{
        copySet(state.repHAAS, state.repHAAD);
        makeButtons('reports-ha-AD', S.consts.REPORTS_HA, state.repHAAD);
        S.rebuild();
      });
    }

    wireLiveTextarea('reportsAS-custom','repCustomAS');
    wireLiveTextarea('reportsAD-custom','repCustomAD');
    wireLiveTextarea('custom-subjective','subjCustom');
  }

  /* ============================
     WIRE OBJECTIVE
     ============================ */
  function wireObjective(){

    /* Otoscopy */
    makeButtons('oto-AS-canal', S.consts.OTO_CANAL, state.otoAScanal);
    makeButtons('oto-AS-tm',    S.consts.OTO_TM,    state.otoAStm);
    makeButtons('oto-AD-canal', S.consts.OTO_CANAL, state.otoADcanal);
    makeButtons('oto-AD-tm',    S.consts.OTO_TM,    state.otoADtm);

    const otoCopy = document.querySelector('[data-copy="oto-AS-to-AD"]');
    if(otoCopy){
      otoCopy.addEventListener('click', ()=>{
        copySet(state.otoAScanal, state.otoADcanal);
        copySet(state.otoAStm,    state.otoADtm);
        makeButtons('oto-AD-canal', S.consts.OTO_CANAL, state.otoADcanal);
        makeButtons('oto-AD-tm',    S.consts.OTO_TM,    state.otoADtm);
        S.rebuild();
      });
    }

    wireLiveTextarea('oto-AS-custom','otoCustomAS');
    wireLiveTextarea('oto-AD-custom','otoCustomAD');

    /* Outside Audiogram */
    const src = document.getElementById('audio-obj-src');
    if(src){
      src.addEventListener('input', ()=>{
        state.audioObjSrc = src.value.trim();
        S.rebuild();
      });
    }

    makeButtons('audio-obj-AS-deg',  S.consts.AUDIO_DEG,        state.audioObjASdeg);
    makeButtons('audio-obj-AD-deg',  S.consts.AUDIO_DEG,        state.audioObjADdeg);
    makeButtons('audio-obj-AS-type', S.consts.AUDIO_TYPE_ONLY,  state.audioObjAStype);
    makeButtons('audio-obj-AD-type', S.consts.AUDIO_TYPE_ONLY,  state.audioObjADtype);
    makeButtons('audio-obj-AS-conf', S.consts.AUDIO_CONFIG,     state.audioObjASconf);
    makeButtons('audio-obj-AD-conf', S.consts.AUDIO_CONFIG,     state.audioObjADconf);

    const aobjCopy = document.querySelector('[data-copy="aobj-AS-to-AD"]');
    if(aobjCopy){
      aobjCopy.addEventListener('click', ()=>{
        copySet(state.audioObjASdeg,   state.audioObjADdeg);
        copySet(state.audioObjAStype,  state.audioObjADtype);
        copySet(state.audioObjASconf,  state.audioObjADconf);
        makeButtons('audio-obj-AD-deg',  S.consts.AUDIO_DEG,        state.audioObjADdeg);
        makeButtons('audio-obj-AD-type', S.consts.AUDIO_TYPE_ONLY,  state.audioObjADtype);
        makeButtons('audio-obj-AD-conf', S.consts.AUDIO_CONFIG,     state.audioObjADconf);
        S.rebuild();
      });
    }

    wireLiveTextarea('audio-obj-AS-custom','audioObjCustomAS');
    wireLiveTextarea('audio-obj-AD-custom','audioObjCustomAD');


    /* HA Condition */
    makeButtons('hac-AS', S.consts.HAC_OPTS, state.hacAS);
    makeButtons('hac-AD', S.consts.HAC_OPTS, state.hacAD);

    const hacCopy = document.querySelector('[data-copy="hac-AS-to-AD"]');
    if(hacCopy){
      hacCopy.addEventListener('click', ()=>{
        copySet(state.hacAS, state.hacAD);
        makeButtons('hac-AD', S.consts.HAC_OPTS, state.hacAD);
        S.rebuild();
      });
    }

    wireLiveTextarea('hac-AS-custom','hacCustomAS');
    wireLiveTextarea('hac-AD-custom','hacCustomAD');

      /* Clearance */
    const clearSub = document.getElementById('clearance-sub');
    if(clearSub){
      clearSub.addEventListener('click', e=>{
        const statusBtn = e.target.closest('button[data-clearance]');
        const earBtn    = e.target.closest('button[data-clear-ear]');

        // Status (Received / Not received)
        if(statusBtn){
          const val = statusBtn.dataset.clearance === 'received' ? 'received' : 'not received';
          state.clearance = (state.clearance === val) ? '' : val;

          clearSub.querySelectorAll('button[data-clearance]').forEach(btn=>{
            btn.classList.toggle('toggled', btn === statusBtn && state.clearance === val);
          });

          S.rebuild();
          return;
        }

        // Ear toggles (AS / AD)
        if(earBtn){
          const ear = earBtn.dataset.clearEar;
          if(ear === 'AS'){
            state.clearanceAS = !state.clearanceAS;
          } else if(ear === 'AD'){
            state.clearanceAD = !state.clearanceAD;
          }

          clearSub.querySelectorAll('button[data-clear-ear]').forEach(btn=>{
            const eEar = btn.dataset.clearEar;
            const on = (eEar === 'AS') ? state.clearanceAS : state.clearanceAD;
            btn.classList.toggle('toggled', on);
          });

          S.rebuild();
        }
      });
    }

    const clearDoc = document.getElementById('clearance-doc');
    if(clearDoc){
      clearDoc.addEventListener('input', ()=>{
        state.clearanceDoc = clearDoc.value.trim();
        S.rebuild();
      });
    }

    wireLiveTextarea('custom-objective','objCustom');

  }

  /* ============================
     WIRE ASSESSMENT
     ============================ */
  function wireAssessment(){

    /* In-office Audiogram */
    makeButtons('audio-AS-deg',  S.consts.AUDIO_DEG,        state.audioASdeg);
    makeButtons('audio-AD-deg',  S.consts.AUDIO_DEG,        state.audioADdeg);
    makeButtons('audio-AS-type', S.consts.AUDIO_TYPE_ONLY,  state.audioAStype);
    makeButtons('audio-AD-type', S.consts.AUDIO_TYPE_ONLY,  state.audioADtype);
    makeButtons('audio-AS-conf', S.consts.AUDIO_CONFIG,     state.audioASconf);
    makeButtons('audio-AD-conf', S.consts.AUDIO_CONFIG,     state.audioADconf);

    const aCopy = document.querySelector('[data-copy="audio-AS-to-AD"]');
    if(aCopy){
      aCopy.addEventListener('click', ()=>{
        copySet(state.audioASdeg,   state.audioADdeg);
        copySet(state.audioAStype,  state.audioADtype);
        copySet(state.audioASconf,  state.audioADconf);
        makeButtons('audio-AD-deg',  S.consts.AUDIO_DEG,        state.audioADdeg);
        makeButtons('audio-AD-type', S.consts.AUDIO_TYPE_ONLY,  state.audioADtype);
        makeButtons('audio-AD-conf', S.consts.AUDIO_CONFIG,     state.audioADconf);
        S.rebuild();
      });
    }

    wireLiveTextarea('audio-AS-custom','audioCustomAS');
    wireLiveTextarea('audio-AD-custom','audioCustomAD');


    /* Insurance */
    const insSub = document.getElementById('ins-sub');
    if(insSub){
      insSub.addEventListener('click', e=>{
        const b = e.target.closest('button[data-auth]');
        if(!b) return;
        const val = b.dataset.auth;
        state.insurance.status = (state.insurance.status === val) ? null : val;
        [...document.querySelectorAll('button[data-auth]')].forEach(x=>{
          x.classList.toggle('toggled', state.insurance.status === x.dataset.auth);
        });
        S.rebuild();
      });
    }

    const insCompany = document.getElementById('ins-company');
    const insBenefit = document.getElementById('ins-benefit');
    const insOOP     = document.getElementById('ins-oop');

    if(insCompany){
      insCompany.addEventListener('input', ()=>{
        state.insCompany = insCompany.value.trim();
        S.rebuild();
      });
    }
    if(insBenefit){
      insBenefit.addEventListener('input', ()=>{
        state.insBenefit = insBenefit.value.trim();
        S.rebuild();
      });
    }
    if(insOOP){
      insOOP.addEventListener('input', ()=>{
        state.insOOP = insOOP.value.trim();
        S.rebuild();
      });
    }

/* HA Recommendation */
makeButtons('ha-style-row', S.consts.HA_STYLES, state.haStyle);
makeButtons('ha-coupling-row', S.consts.HA_COUPLING, state.haCoupling);
makeButtons('order-coupling-row', S.consts.HA_COUPLING, state.orderCoupling);

  // Recommendation ear scope
  document.querySelectorAll('button[data-recscope]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const ear = btn.dataset.recscope;
      if(ear === 'AS') state.haRecAS = !state.haRecAS;
      if(ear === 'AD') state.haRecAD = !state.haRecAD;

      document.querySelectorAll('button[data-recscope]').forEach(b=>{
        const e = b.dataset.recscope;
        const on = (e === 'AS' && state.haRecAS) ||
                   (e === 'AD' && state.haRecAD);
        b.classList.toggle('toggled', on);
      });

      S.rebuild();
    });
  });

    // Order scope: AS / AD buttons, internally '', 'AS', 'AD', or 'AU'
    function updateOrderScopeButtons(){
      const scope = state.order.scope; // '', 'AS', 'AD', 'AU'
      document.querySelectorAll('button[data-orderscope]').forEach(b=>{
        const ear = b.dataset.orderscope; // "AS" or "AD"
        const on = (scope === 'AU') || (scope === ear);
        b.classList.toggle('toggled', on);
      });
    }

    document.querySelectorAll('button[data-orderscope]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const ear = btn.dataset.orderscope; // "AS" or "AD"
        const cur = state.order.scope;      // current value

        if(cur === ear){
          // Clicking the same ear turns everything off
          state.order.scope = '';
        } else if(cur === ''){
          // Nothing selected -> select this ear
          state.order.scope = ear;
        } else if(cur === 'AU'){
          // Both selected; clicking one means "only the other ear"
          state.order.scope = (ear === 'AS') ? 'AD' : 'AS';
        } else {
          // One ear selected; clicking the other -> AU
          state.order.scope = 'AU';
        }

        updateOrderScopeButtons();
        S.rebuild();
      });
    });

    // Initialize button states on load
    updateOrderScopeButtons();


// Hearing aid details text box
const haTech = document.getElementById('ha-tech');
if(haTech){
  haTech.addEventListener('input', ()=>{
    state.haTech = haTech.value.trim();
    S.rebuild();
  });
}

    /* Order (live) */
    function bindOrderInput(id, key){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('input', ()=>{
        state.order[key] = el.value.trim();
        S.rebuild();
      });
    }
    function bindOrderSelect(id, key){
      const el = document.getElementById(id);
      if(!el) return;
      el.addEventListener('change', ()=>{
        state.order[key] = el.value;
        S.rebuild();
      });
    }

    bindOrderInput('order-mfg','mfg');
    bindOrderInput('order-model','model');
    bindOrderInput('order-style','style');
    bindOrderInput('order-color','color');

    // Receiver lengths / powers
    bindOrderSelect('rec-len-AS','recLenAS');
    bindOrderSelect('rec-len-AD','recLenAD');
    bindOrderInput('rec-pwr-AS','recPwrAS');
    bindOrderInput('rec-pwr-AD','recPwrAD');

    // Ear mold style / material / color â€” independent per ear
    bindOrderSelect('order-mold-type-AS','moldTypeAS');
    bindOrderSelect('order-mold-type-AD','moldTypeAD');
    bindOrderSelect('order-mold-material-AS','moldMaterialAS');
    bindOrderSelect('order-mold-material-AD','moldMaterialAD');
    bindOrderInput('mold-color-AS','moldColorAS');
    bindOrderInput('mold-color-AD','moldColorAD');

    bindOrderInput('order-extra','extraDetails');

    // Copy entire left coupling row â†’ right
    const copyCouplingBtn = document.getElementById('copy-coupling-AS-to-AD');
    if(copyCouplingBtn){
      copyCouplingBtn.addEventListener('click', ()=>{
        const lenAS  = document.getElementById('rec-len-AS');
        const lenAD  = document.getElementById('rec-len-AD');
        const pwrAS  = document.getElementById('rec-pwr-AS');
        const pwrAD  = document.getElementById('rec-pwr-AD');
        const typeAS = document.getElementById('order-mold-type-AS');
        const typeAD = document.getElementById('order-mold-type-AD');
        const matAS  = document.getElementById('order-mold-material-AS');
        const matAD  = document.getElementById('order-mold-material-AD');
        const moldAS = document.getElementById('mold-color-AS');
        const moldAD = document.getElementById('mold-color-AD');

        if(lenAS && lenAD){
          lenAD.value = lenAS.value;
          state.order.recLenAD = lenAS.value || '';
        }
        if(pwrAS && pwrAD){
          pwrAD.value = pwrAS.value;
          state.order.recPwrAD = pwrAS.value || '';
        }
        if(typeAS && typeAD){
          typeAD.value = typeAS.value;
          state.order.moldTypeAD = typeAS.value || '';
        }
        if(matAS && matAD){
          matAD.value = matAS.value;
          state.order.moldMaterialAD = matAS.value || '';
        }
        if(moldAS && moldAD){
          moldAD.value = moldAS.value;
          state.order.moldColorAD = moldAS.value || '';
        }

        S.rebuild();
      });
    }


    // Impression toggles (Assessment)
    document.querySelectorAll('[data-impression]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const v = btn.dataset.impression;

        // toggle
        state.impressionStatus = (state.impressionStatus === v ? '' : v);

        document.querySelectorAll('[data-impression]').forEach(b=>{
          b.classList.toggle('toggled', b.dataset.impression === state.impressionStatus);
        });

        S.rebuild();
      });
    });


// Tube type: slim tube vs receiver
document
  .querySelectorAll('button[data-order-tube], button[data-ordertube]')
  .forEach(btn => {
    btn.addEventListener('click', () => {
      // Support either data-order-tube or data-ordertube in the HTML
      const v = btn.dataset.orderTube || btn.dataset.ordertube || '';

      // Toggle selection
      state.order.tubeType = (state.order.tubeType === v) ? '' : v;

      // Update button visuals
      document
        .querySelectorAll('button[data-order-tube], button[data-ordertube]')
        .forEach(b => {
          const val = b.dataset.orderTube || b.dataset.ordertube || '';
          b.classList.toggle('toggled', val && val === state.order.tubeType);
        });

      S.rebuild();
    });
  });

    /* HA Maintenance */
    /* HA Maintenance */
    makeButtons('ham-AS', S.consts.HAM_OPTS, state.hamAS);
    makeButtons('ham-AD', S.consts.HAM_OPTS, state.hamAD);

    const hamCopy = document.querySelector('[data-copy="ham-AS-to-AD"]');
    if(hamCopy){
      hamCopy.addEventListener('click', ()=>{
        copySet(state.hamAS, state.hamAD);
        makeButtons('ham-AD', S.consts.HAM_OPTS, state.hamAD);
        S.rebuild();
      });
    }

    wireLiveTextarea('ham-AS-custom','hamCustomAS');
    wireLiveTextarea('ham-AD-custom','hamCustomAD');

    /* HA Post-maintenance */
    makeButtons('ham-post-AS', S.consts.HAM_POST_OPTS, state.hamPostAS);
    makeButtons('ham-post-AD', S.consts.HAM_POST_OPTS, state.hamPostAD);

    const hamPostCopy = document.querySelector('[data-copy="ham-post-AS-to-AD"]');
    if(hamPostCopy){
      hamPostCopy.addEventListener('click', ()=>{
        copySet(state.hamPostAS, state.hamPostAD);
        makeButtons('ham-post-AD', S.consts.HAM_POST_OPTS, state.hamPostAD);
        S.rebuild();
      });
    }

    wireLiveTextarea('ham-post-AS-custom','hamPostCustomAS');
    wireLiveTextarea('ham-post-AD-custom','hamPostCustomAD');

    wireLiveTextarea('custom-assessment','assessCustom');
  }

  /* ============================
     WIRE PLAN
     ============================ */

function wirePlan(){

  // ðŸ”¹ Generate the Plan buttons from S.consts.PLAN_ITEMS
  makeButtons('plan-items', S.consts.PLAN_ITEMS, state.planItems);

  const rtcTime = document.getElementById('rtc-time');
  if(rtcTime){
    rtcTime.addEventListener('input', ()=>{
      state.rtcTime = rtcTime.value;
      S.rebuild();
    });
  }

  document.querySelectorAll('button[data-rtcunit]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const unit = btn.dataset.rtcunit;
      state.rtcUnit = (state.rtcUnit === unit) ? '' : unit;
      document.querySelectorAll('button[data-rtcunit]').forEach(b=>{
        b.classList.toggle('toggled', b.dataset.rtcunit === state.rtcUnit);
      });
      S.rebuild();
    });
  });

  const rtcAs = document.getElementById('rtc-asneeded');
  if(rtcAs){
    rtcAs.addEventListener('click', ()=>{
      state.rtcAsNeeded = !state.rtcAsNeeded;
      rtcAs.classList.toggle('toggled', state.rtcAsNeeded);
      S.rebuild();
    });
  }

  const rtcClear = document.getElementById('rtc-clear');
  if(rtcClear){
    rtcClear.addEventListener('click', ()=>{
      state.rtcTime = '';
      state.rtcUnit = '';
      state.rtcAsNeeded = false;

      const t = document.getElementById('rtc-time');
      if(t) t.value = '';

      document.querySelectorAll('button[data-rtcunit]').forEach(b=>b.classList.remove('toggled'));
      const asbtn = document.getElementById('rtc-asneeded');
      if(asbtn) asbtn.classList.remove('toggled');

      S.rebuild();
    });
  }

  wireLiveTextarea('custom-plan','planCustom');
}


  /* ============================
     NOTE CONTROLS
     ============================ */
  function wireNoteControls(){
    const copyBtn = document.getElementById('copy-note');
    const clearBtn = document.getElementById('clear-note');

    if(copyBtn){
      copyBtn.addEventListener('click', async ()=>{
        const text = document.getElementById('noteArea').value;
        try{
          await navigator.clipboard.writeText(text);
        }catch(e){
          console.error('Clipboard copy failed', e);
        }
      });
    }

    if(clearBtn){
      clearBtn.addEventListener('click', ()=>{
        /* Reset everything */
        resetState();

        document.querySelectorAll('.btn.toggled').forEach(b=>b.classList.remove('toggled'));
        document.querySelectorAll('input[type="text"],input[type="number"]').forEach(i=>i.value='');
        document.querySelectorAll('textarea').forEach(t=>t.value='');
        document.querySelectorAll('select').forEach(s=>s.selectedIndex = 0);

        S.rebuild();
      });
    }
  }
  

  /* ============================
     INIT
     ============================ */
  function init(){
    wireSubjective();
    wireObjective();
    wireAssessment();
    wirePlan();
    wireNoteControls();
    S.rebuild();
  }

  document.addEventListener('DOMContentLoaded', init);

  return S;
})();

</script>

</body>
</html>

